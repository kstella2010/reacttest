<!DOCTYPE html>
<html>

<head>
    <title>ML Model</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.0/css/all.min.css">
</head>

<body>
  <nav class="nav-bar fixed-bottom bg-light">
    <div class="container">
      <ul class="nav justify-content-center nav-bar">
        <li class="nav-item">
          <a class="nav-link" href="manage_patients.html">
            <i class="fas fa-users fa-2x"></i> <!-- Font Awesome users icon -->
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="add_patient.html">
            <i class="fas fa-user-plus fa-2x"></i> <!-- Font Awesome user-plus icon -->
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="run_ml.html">
            <i class="fas fa-cogs fa-2x"></i> <!-- Font Awesome cogs icon -->
          </a>
        </li>
      </ul>
    </div>
  </nav>  

    <!-- ML Model Section -->
    <div class="container mt-4">
        <h2>ML Model</h2>

        <!-- Patient dropdown -->
        <div class="container mt-4">
          <label for="patientDropdown">Select a Patient:</label>
          <!-- Input for searching patients -->
          <input type="text" id="searchInput" class="form-control" placeholder="Search for a patient">
          <select id="patientDropdown" class="form-select">
            <option value="" disabled selected>Select a patient</option>
          </select>
        </div>
        <form id="symptomsForm" class="container mt-4"></form>
        <!-- Symptoms Section -->
        <div>
            <h3>Symptoms</h3>

            <!-- Clinical Signs -->
            <div class="mb-3">
                <strong>Clinical Signs</strong>
                <div>
                    <input type="checkbox" id="anorexia" name="clinicalSigns">
                    <label for="anorexia">Anorexia</label>
                </div>
                <div>
                    <input type="checkbox" id="depression" name="clinicalSigns">
                    <label for="depression">Depression</label>
                </div>
                <div>
                    <input type="checkbox" id="lethargy" name="clinicalSigns">
                    <label for="lethargy">Lethargy</label>
                </div>
            </div>

            <!-- Respiratory Signs -->
            <div class="mb-3">
                <strong>Respiratory Signs</strong>
                <div>
                    <input type="checkbox" id="tachypnea" name="respiratorySigns">
                    <label for="tachypnea">Tachypnea</label>
                </div>
                <div>
                    <input type="checkbox" id="dyspnea" name="respiratorySigns">
                    <label for="dyspnea">Dyspnea</label>
                </div>
            </div>

            <!-- Intestinal Signs -->
            <div class="mb-3">
                <strong>Intestinal Signs</strong>
                <div>
                    <input type="checkbox" id="diarrhea" name="intestinalSigns">
                    <label for="diarrhea">Diarrhea</label>
                </div>
                <div>
                    <input type="checkbox" id="tenesmus" name="intestinalSigns">
                    <label for="tenesmus">Tenesmus</label>
                </div>
            </div>
          </form> 

            <!-- Run Model Button -->
            <div class="mb-3">
                <button id="runModelButton" class="btn btn-primary">Run model</button>
            </div>
        </div>
    </div>
</body>

</html>

<script>
  const { ipcRenderer,dialog } = require('electron');
  const fs = require('fs');
  const path = require('path');
  const excel = require('exceljs');

  const searchInput = document.getElementById('searchInput');
  const patientDropdown = document.getElementById('patientDropdown');
  const runModelButton = document.getElementById('runModelButton');

// Event listener for Run Model button
runModelButton.addEventListener('click', async () => {
    const workbook = new excel.Workbook();
    const worksheet = workbook.addWorksheet('Symptoms Data');

    worksheet.columns = [
        { header: 'Clinical Signs', key: 'clinicalSigns', width: 25 },
        { header: 'Respiratory Signs', key: 'respiratorySigns', width: 25 },
        { header: 'Intestinal Signs', key: 'intestinalSigns', width: 25 },
    ];

    const clinicalSigns = getCheckedValues('clinicalSigns');
    const respiratorySigns = getCheckedValues('respiratorySigns');
    const intestinalSigns = getCheckedValues('intestinalSigns');

    worksheet.addRow({
        clinicalSigns: clinicalSigns.join(", "),
        respiratorySigns: respiratorySigns.join(", "),
        intestinalSigns: intestinalSigns.join(", "),
    });

    const patientDir = path.join(__dirname, 'patient_data', selectedPatient);
    await workbook.xlsx.writeFile(path.join(patientDir, 'patient_ml_data.xlsx')).then(() => {
    dialog.showMessageBox({ message: 'Patient Ml Data saved!' });
  });;
});

function getCheckedValues(groupName) {
    const checkboxes = document.querySelectorAll(`input[name="${groupName}"]:checked`);
    let values = [];
    checkboxes.forEach((checkbox) => {
        values.push(checkbox.nextElementSibling.textContent);
    });
    return values;
}

  

  // Function to search for patients based on user input
  // Function to search for patients based on user input
  function searchPatients() {
  const searchTerm = searchInput.value.trim();
  if (!searchTerm) {
      patientDropdown.innerHTML = '<option value="" disabled selected>Select a patient</option>';
      return;
  }

  // Clear previous search results
  patientDropdown.innerHTML = '';

  // Read the patient_data directory to find matching folders
  const patientDataPath = path.join(__dirname, 'patient_data');
  fs.readdir(patientDataPath, (err, files) => {
      if (err) {
      console.error(err);
      return;
      }

      // Filter folders that match the search term (phone or pet name)
      const matchingPatients = files.filter((folderName) => {
      // Check if the search term partially or fully matches the folder name
      if (folderName.toLowerCase().includes(searchTerm.toLowerCase())) {
          return true;
      }
      });

      // Populate the patient dropdown with matching patients
      if (matchingPatients.length === 0) {
      patientDropdown.innerHTML = '<option value="" disabled selected>No matching patients</option>';
      } else {
      matchingPatients.forEach((patientFolder) => {
          const option = document.createElement('option');
          option.value = patientFolder;
          option.text = patientFolder;
          patientDropdown.appendChild(option);
      });
      }
  });
  }

  // Event listener for search input (input event)
  searchInput.addEventListener('input', searchPatients);
  let selectedPatient;
  // Event listener for patient selection in the dropdown
  patientDropdown.addEventListener('change', () => {
  selectedPatient = patientDropdown.value;
  if (selectedPatient) {
  // Modify the URL of the "New Incident" button to include the selected patient
  const runModelButton = document.getElementById('runModelButton');
  runModelButton.href = `new_incident.html?patient=${encodeURIComponent(selectedPatient)}`;
  }

  });


</script>

<style>
  /* Custom CSS for navigation */
  .nav-bar {
    display: flex;
    justify-content: space-between; /* Spread items */
  }

  .nav-link {
    text-decoration: none;
    color: #000; /* Text color */
  }

  .nav-item {
    text-align: center;
    padding-left: 80px;
    padding-right: 80px;
  }
</style>

<style>
    body {
      padding-bottom: 80px; /* Adjust the value as needed */
    }
  </style>
